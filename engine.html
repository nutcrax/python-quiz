<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QCM interactif</title>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; padding: 24px; line-height: 1.35;
    }
    .wrap { max-width: 920px; margin: 0 auto; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .sub { opacity: .8; margin: 0 0 18px; }

    .card {
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 16px;
      padding: 18px;
    }

    .topbar {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .pill {
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 13px;
      opacity: .9;
    }

    pre {
      margin: 12px 0;
      padding: 12px;
      border-radius: 12px;
      overflow:auto;
      background: rgba(127,127,127,.12);
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 13px;
    }

    .qtitle { font-size: 18px; margin: 0 0 8px; }

    .choices {
      display:flex;
      flex-direction: column;
      gap: 10px;
      margin: 10px 0 14px;
    }

    label.choice {
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.25);
      cursor: pointer;
      user-select:none;
    }

    label.choice:hover {
      background: rgba(127,127,127,.08);
    }

    input[type="checkbox"] {
      transform: translateY(2px);
    }

    .actions {
      display:flex;
      gap:10px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid rgba(127,127,127,.35);
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      cursor: pointer;
      background: transparent;
    }

    button.primary {
      background: rgba(127,127,127,.14);
    }

    button:disabled {
      opacity:.5;
      cursor:not-allowed;
    }

    .msg {
      margin-top: 12px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,.35);
    }

    .msg.ok { background: rgba(46, 204, 113, .15); }
    .msg.no { background: rgba(231, 76, 60, .15); }

    .explain { margin-top: 8px; opacity:.92; }
    .hint { font-size: 13px; opacity: .8; margin-top: 10px; }
  </style>
</head>

<body>
<div class="wrap">
  <h1>QCM interactif</h1>
  <p class="sub">
    Les questions sont pr√©sent√©es une par une.
    Tu ne peux passer √† la suivante que si tu coches exactement toutes les bonnes r√©ponses.
  </p>

  <div class="card">
    <div class="topbar">
      <div class="pill" id="progress"></div>
      <div class="pill" id="score"></div>
    </div>

    <div id="qarea"></div>

    <div class="actions">
      <button class="primary" id="checkBtn">Valider</button>
      <button id="nextBtn" disabled>Question suivante</button>
      <button id="resetBtn">Recommencer</button>
    </div>

    <div id="message" class="msg" style="display:none;"></div>

    <div class="hint" id="hint"></div>
  </div>
</div>

<script>
/* ==========================================
   CHARGEMENT DYNAMIQUE DU QUIZ
   ========================================== */

function getQuizPath() {
  const params = new URLSearchParams(window.location.search);
  return params.get("quiz");
}

function loadQuiz(path) {
  return new Promise((resolve, reject) => {
    const script = document.createElement("script");
    script.src = path;
    script.onload = () => resolve();
    script.onerror = () => reject(new Error("Impossible de charger " + path));
    document.head.appendChild(script);
  });
}

const quizPath = getQuizPath();
const hint = document.getElementById("hint");

if (!quizPath) {
  document.getElementById("qarea").innerHTML =
    "<p><strong>Erreur :</strong> aucun quiz sp√©cifi√©.<br>" +
    "Utilise par exemple : <code>engine.html?quiz=Quiz-JS/Boucles/q-boucles-1.js</code></p>";
  hint.textContent = "";
} else {
  hint.textContent = "Quiz charg√© : " + quizPath;
  loadQuiz(quizPath)
    .then(initEngine)
    .catch(err => {
      document.getElementById("qarea").innerHTML =
        "<p><strong>Erreur :</strong> " + err.message + "</p>";
      hint.textContent = "";
    });
}

/* ==========================================
   MOTEUR QCM ‚Äî VERSION ROBUSTE
   ========================================== */

let idx = 0;
let validated = [];
let quiz = null;

function initEngine() {
  quiz = window.QUIZ;

  if (!Array.isArray(quiz)) {
    document.getElementById("qarea").innerHTML =
      "<p><strong>Erreur :</strong> le fichier du quiz ne d√©finit pas <code>QUIZ</code>.</p>";
    return;
  }

  validated = Array(quiz.length).fill(false);

  const qarea = document.getElementById("qarea");
  const progress = document.getElementById("progress");
  const score = document.getElementById("score");
  const msg = document.getElementById("message");
  const checkBtn = document.getElementById("checkBtn");
  const nextBtn = document.getElementById("nextBtn");
  const resetBtn = document.getElementById("resetBtn");

  function esc(s) {
    return s.replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

  function render() {
    const q = quiz[idx];
    progress.textContent = `Question ${idx + 1} / ${quiz.length}`;
    score.textContent = `Valid√©es : ${validated.filter(Boolean).length} / ${quiz.length}`;
    msg.style.display = "none";
    nextBtn.disabled = true;

    qarea.innerHTML = `
      <div class="qtitle"><strong>${esc(q.title)}</strong></div>
      <pre><code>${esc(q.code)}</code></pre>
      <div class="choices">
        ${q.choices.map((t,i)=>`
          <label class="choice">
            <input type="checkbox" data-i="${i}">
            <div>${esc(t)}</div>
          </label>`).join("")}
      </div>`;
  }

  function checked() {
    return [...document.querySelectorAll("input[type=checkbox]")]
      .filter(c=>c.checked)
      .map(c=>+c.dataset.i)
      .sort();
  }

  function same(a,b) {
    return a.length===b.length && a.every((v,i)=>v===b[i]);
  }

  checkBtn.onclick = () => {
    const q = quiz[idx];
    if (same(checked(), [...q.correct].sort())) {
      validated[idx] = true;
      msg.className = "msg ok";
      msg.innerHTML = `<strong>Correct ‚úî</strong><div class="explain">${esc(q.explanation)}</div>`;
      msg.style.display = "block";
      nextBtn.disabled = false;
    } else {
      msg.className = "msg no";
      msg.innerHTML = "<strong>Pas encore ‚ùå</strong><div class='explain'>La s√©lection n‚Äôest pas exactement correcte.</div>";
      msg.style.display = "block";
    }
    score.textContent = `Valid√©es : ${validated.filter(Boolean).length} / ${quiz.length}`;
  };

  nextBtn.onclick = () => {
    if (idx < quiz.length - 1) {
      idx++;
      render();
    } else {
      qarea.innerHTML = "<h2>üéâ Termin√©</h2><p>Bravo !</p>";
      progress.textContent = "Fin";
      nextBtn.disabled = true;
    }
  };

  resetBtn.onclick = () => {
    idx = 0;
    validated = Array(quiz.length).fill(false);
    render();
  };

  render();
}
</script>

</body>
</html>
